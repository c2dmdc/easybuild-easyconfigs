easyblock = 'MakeCp'

name = 'Siesta'
version = '3.2-pl-5'

homepage = 'http://departments.icmab.es/leem/siesta'
description = """SIESTA is both a method and its computer program implementation, to perform efficient electronic
 structure calculations and ab initio molecular dynamics simulations of molecules and solids."""

toolchain = {'name': 'intel', 'version': '2016.02-GCC-4.9'}
toolchainopts = {'usempi': True}

sources = [SOURCELOWER_TGZ]
source_urls = ['https://dl.dropbox.com/u/20267285/SIESTA-DOWNLOADS/']

cfg_cmd = '../Src/obj_setup.sh && ../Src/configure --enable-mpi'
# must override COMP_LIBS in order to ensure usage of MKL's lapack instead of internal
build_vars = "COMP_LIBS='' "
build_vars += 'BLAS_LIBS="$LIBBLAS" LAPACK_LIBS="$LIBLAPACK" BLACS_LIBS="$LIBBLACS" SCALAPACK_LIBS="$LIBSCALAPACK"'

# build siesta
prebuildopts = "cd Obj && " + cfg_cmd + ' && '
buildopts = build_vars + ' && '
# build transiesta
buildopts += "cd .. && mkdir Obj2 && cd Obj2 && " + cfg_cmd + " && make transiesta " + build_vars + ' && '
# build all utils
buildopts += 'cd ../Util && sh ./build_all.sh'

parallel = 1

files_to_copy = [(['Obj/siesta', 'Obj2/transiesta', 'Util/Bands/eigfat2plot', 'Util/Bands/new.gnubands',
                   'Util/Bands/gnubands', 'Util/CMLComp/ccViz', 'Util/COOP/mprop', 'Util/COOP/dm_creator',
                   'Util/COOP/fat', 'Util/Contrib/APostnikov/eig2bxsf', 'Util/Contrib/APostnikov/xv2xsf',
                   'Util/Contrib/APostnikov/md2axsf', 'Util/Contrib/APostnikov/rho2xsf',
                   'Util/Contrib/APostnikov/vib2xsf', 'Util/Contrib/APostnikov/fmpdos',
                   'Util/Denchar/Examples/2dplot.py', 'Util/Denchar/Examples/surf.py', 'Util/Denchar/Src/denchar',
                   'Util/DensityMatrix/dm2cdf', 'Util/DensityMatrix/cdf2dm', 'Util/Eig2DOS/Eig2DOS',
                   'Util/Gen-basis/ionplot.sh', 'Util/Gen-basis/gen-basis', 'Util/Gen-basis/ioncat',
                   'Util/Grid/grid2cdf', 'Util/Grid/cdf2xsf', 'Util/Grid/cdf2grid', 'Util/Grid/grid2val',
                   'Util/Grid/grid2cube', 'Util/HSX/hsx2hs', 'Util/HSX/hs2hsx', 'Util/Helpers/get_chem_labels',
                   'Util/MPI_test/pi3', 'Util/Macroave/Src/macroave', 'Util/ON/lwf2cdf', 'Util/Optimizer/swarm',
                   'Util/Optimizer/simplex', 'Util/Projections/orbmol_proj', 'Util/STM/simple-stm/plstm',
                   'Util/SiestaSubroutine/FmixMD/Src/simple', 'Util/SiestaSubroutine/FmixMD/Src/driver',
                   'Util/SiestaSubroutine/FmixMD/Src/para', 'Util/TBTrans/tbtrans', 'Util/VCA/mixps',
                   'Util/VCA/fractional', 'Util/Vibra/Src/fcbuild', 'Util/Vibra/Src/vibrator', 'Util/WFS/readwf',
                   'Util/WFS/readwfx', 'Util/WFS/info_wfsx', 'Util/WFS/wfs2wfsx', 'Util/WFS/wfsx2wfs',
                   'Util/WFS/wfsnc2wfsx', 'Util/pdosxml/pdosxml', 'Util/pseudo-xml/xml2psf',
                   'Util/test-xml/test-xml'], 'bin')]

sanity_check_paths = {
    'files': ['bin/siesta', 'bin/transiesta', 'bin/tbtrans', 'bin/eigfat2plot', 'bin/new.gnubands', 'bin/gnubands',
              'bin/ccViz', 'bin/mprop', 'bin/dm_creator', 'bin/fat', 'bin/eig2bxsf', 'bin/xv2xsf', 'bin/md2axsf',
              'bin/rho2xsf', 'bin/vib2xsf', 'bin/fmpdos', 'bin/2dplot.py', 'bin/surf.py', 'bin/denchar', 'bin/dm2cdf',
              'bin/cdf2dm', 'bin/Eig2DOS', 'bin/ionplot.sh', 'bin/gen-basis', 'bin/ioncat', 'bin/grid2cdf',
              'bin/cdf2xsf', 'bin/cdf2grid', 'bin/grid2val', 'bin/grid2cube', 'bin/hsx2hs', 'bin/hs2hsx',
              'bin/get_chem_labels', 'bin/pi3', 'bin/macroave', 'bin/lwf2cdf', 'bin/swarm', 'bin/simplex',
              'bin/orbmol_proj', 'bin/plstm', 'bin/simple', 'bin/driver', 'bin/para', 'bin/tbtrans', 'bin/mixps',
              'bin/fractional', 'bin/fcbuild', 'bin/vibrator', 'bin/readwf', 'bin/readwfx', 'bin/info_wfsx',
              'bin/wfs2wfsx', 'bin/wfsx2wfs', 'bin/wfsnc2wfsx', 'bin/pdosxml', 'bin/xml2psf', 'bin/test-xml'],
    'dirs': []
}

moduleclass = 'phys'
